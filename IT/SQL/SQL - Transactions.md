# SQL: TRANSACTIONS
**_Транзакция_** - конструкция, которая задает последовательность инструкций языка SQL (чтения или записи) для обеспечения согласованности данных.
```
BEGIN TRANSACTION
	ROLLBACK
COMMIT
```
#### Типы транзакций:
- **_Неявная транзакция_** - любая отдельная инструкция **INSERT**, **UPDATE** или **DELETE**
- **_Явная транзакция_** - группа инструкций языка SQL начало и конец которой обозначаются такими инструкциями, как **BEGIN TRANSACTION**, **COMMIT** и **ROLLBACK**.
#### Свойства транзакций (ACID)
- **_Atomicity (Атомарность)_** - неделимость набора инструкций, то есть или все инструкции выполнятся, но при ошибке в каком-то запросе - откатываются все измененные данные;
- **_Consistency (Согласованность)_** - свойство обеспечивает согласованность данных, то есть транзакция переводит данные из одного согласованного состояния в другое согласованное;
- **_Isolation (Изолированность)_** - отделяет все параллельные транзакции друг от друга; то есть активная транзакция не может видеть модификации данных в параллельных или отмененных транзакциях.
- **_Durability (Долговечность)_** - свойство сохраняемости данных, то есть способность транзакции сохранять результат и состояние транзакции в случае сбоев.
#### Распределенная транзакция
 Транзакция, которая используется на нескольких базах данных или нескольких серверах. Запуск распределенной транзакции. 
```
BEGIN DISTRIBUTED TRANSACTION
```
#### Журнал транзакций
История обо всех изменениях в базе данных. Любая операция/конструкция языка записана в этот журнал транзакций с значениями до/после.
Каждой записи в журнале транзакций присваивается однозначный идентификатор. Все записи журнала, являющиеся частью определенной транзакции, связаны друг с другом, чтобы можно было найти все части этой транзакции для операции отмены или повтора.

#### Уровень изолированности транзакций
Условное значение, определяющее в какой мере в результате выполнения логически параллельных транзакций допускается получение несогласованных данных.
Высокий уровень изолированности позволяет добиться большей согласованности данных, но такой уровень снижает количество параллельных транзакций.
Более низкий уровень - увеличивает кол-во параллельных транзакций, но уменьшает точность данных.
#### Проблемы параллельного доступа 
##### Lost update (потерянное обновление)
Когда 2 или более транзакций выполняют изменение одного и того же блока данных параллельно, в итоге завершения данные одной из них теряются.
a = 0
T1:  a = a + 20
T2: a = a + 25
R: a = 20 или 25 (ожидалось 45)
##### Dirty read ("Грязное" чтение)
Чтение данных, добавленных или измененных транзакцией, которая в последствии не подтвердится (откатится).
a = 0
T1: a = a + 20
T2: a = 20
T1: Rollback
a(T1) = 0
a(T2) = 20
##### Non-repeatable read (Не повторяющееся чтение)
Ситуация, когда при повторном чтении блока данных в рамках одной транзакции, данные меняются.
T1: select A
T2: update A
T2: commit A
T1: select A
#####  Phantom read (потерянное обновление)
Ситуация, когда при повторном чтении блока данных в рамках одной транзакции, одна и та же выборка дает разные множества строк.
T1: select SUM(A)
T2: insert NEW_A_VALUE
T2: commit NEW_A_VALUE
T1: select SUM(A)
#### Уровни изоляции
##### Read uncommitted (Чтение незафиксированных данных)
Самый низний уровень изоляции. При этому уровне происходит чтение данных, как с зафиксированных транзакций, так и не завершенных транзакций, что приводит к получению несогласованных данных. Транзакции выполняющие только чтение не блокируются. 
##### Read committed (Чтение фиксированных данных)
В большинстве СУБД это уровень по-умолчанию. На этом уровне запрещено "грязное чтение". Тем не менее в процессе выполнения 2х транзакций - одна транзакция может быть выполнена и набор данных для второй транзакции изменится, что может привести к "фантомному" или неповторяющемуся чтению.
Чтение фиксированных данных может быть основана на блокировании или версионности.
##### Repeatable read (Повторяющееся чтение)
Блок прочитанных данных блокируется от изменения. Но могут быть вставлены новые строки с условиями выборки на чтение, что приведет к проблеме "фантомное чтение".
##### Serializable (Упорядочиваемость)
Самый высокий уровень изолированности. Транзакции полностью изолируются друг от друга. Результат выполнения нескольких параллельных транзакций должен быть таким, как если бы они выполнялись последовательно. 
Только в этом режиме данные не подвержены эффекту "фантомное чтение".
### Tags:
#sql #develop #interview