# SQL: LOCKS

**_Блокировка_** - механизм предотвращения одновременного конкурентного доступа к данным.

Когда одна конструкция пытается получить заблокированные данные - СУБД выдает ошибку или просит ожидать снятия блокировки.
#### Свойства блокировки
##### Длительность блокировки
Период времени, в течении которого ресурс удерживает определенную блокировку. Длительность блокировки зависит, среди прочего, от режима блокировки и уровня изоляции.
##### Режим блокировки
Для блокировки строки и страницы применяют следующие типы блокировок:
- **_Shared lock (разделяемая блокировка)_**
	Резервирует ресурс (страницу или строку) только для чтения. Другие процессы не могут изменять заблокированный таким образом ресурс. Но другие процессы могут накладывать свой shared lock блокировку на этот же набор данных. Иными словами, чтение данных с shared lock блокировкой могу производить несколько процессов.
- **_Exclusive lock (монопольная блокировка)_**
	Резервирует ресурс (страницу или строку) для монопольного использования одной транзакции. Блокировка этого типа применяется инструкциями _INSERT_,  _UPDATE_ и _DELETE_, которые модифицируют ресурс. Exclusive lock нельзя установить, если на ресурс установлены другие Shared lock или Exclusive lock блокировки.
- **_Update lock (блокировка обновления)_**
	Не может быть установлена, если на ресурс уже наложена другая блокировка обновления или монопольная. Может быть установлена на ресурс с Shared lock блокировкой. Другими словами работает как - "Я планирую, что-то обновить". Блокировка обновления применяется для предотвращения определенных распространенных типов взаимоблокировок.

СУБД сама автоматически устанавливает режим блокировки в зависимости от типа операции чтение или запись.
##### Гранулярность блокировки
Определяет, какой ресурс блокируется в одной попытке блокировки. Система может блокировать следующие ресурсы: строки, страницы, индексные ключи или диапазон индексных включей, таблицы или саму базу данных. Система выбирает требуемую гранулярность блокировки автоматически.
Строка - наименьший ресурс, который можно заблокировать.
Гранулярность блокировки оказывает на одновременный конкурентный доступ. Чем выше уровень гранулярности, тем больше сокращается возможность одновременного доступа к данным.
##### Укрупнение блокировок
Если в процессе транзакции существует большое кол-во блокировок одного типа, то СУБД может объединить в одну блокировку уровня таблицы - этот процесс называется укрупнением блокировки. LOCK_ESCALATION = DISABLE - настройка позволяет отключить укрупнение блокировки для большинства случаев.

##### Параметр LOCK_TIMEOUT
Чтобы процесс транзакции не ожидал разблокировку ресурса до бесконечности, можно установить задать время ожидания.
```
SET LOCK_TIMEOUT 8000(миллисекунд)
```
##### Deadlock (Взаимоблокировки)
Одновременный конкурентный доступ в ресурсу, в котором две транзакции блокируют друг друга.
Для решения этого типа блокировки можно установить приоритет взаимоблокировки (DEADLOCK_PRIORITY)
```
SET DEADLOCK_PRIORITY {LOW | NORMAL | HIGHT | -10 ... 10}
```
